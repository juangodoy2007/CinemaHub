<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= titulo %>
  </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <link rel="icon" href="/images/fav.ico" />
</head>

<body>
  <main class="d-flex" style="min-height: 100dvh;">
    <!-- navegacion -->
    <header class="d-flex flex-column gap-4 border-end d-none d-md-block" id="menuNav">
      <div class="sticky-top">
        <div class="" style="min-height: 25dvh;">
          <div class="d-flex align-items-center p-4 gap-2 d-none contenido">
            <div class="d-flex bg-black p-2 rounded-1">
              <p class="card-title p-1 pe-0 text-light fw-bold">
                Cinema
              </p>
              <p class="card-title p-1 rounded-1 fw-bold" style="background-color: #F69416;">
                Hub
              </p>
            </div>
          </div>
          <div class="card-body ps-4 d-none contenido">
            <h5><strong> Bienvenido </strong>
              usuario
            </h5>
          </div>
        </div>
        <ul class="d-flex flex-column list-unstyled ps-2 pe-2">
          <li class="d-flex align-items-center justify-content-center">
            <a href="/peliculas" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-film"></i>
              <p class="mb-0 d-none contenido">
                Peliculas
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center bg-dark">
            <a href="/funciones" class="text-white w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-masks-theater"></i>
              <p class="mb-0 d-none contenido">
                Funciones
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center">
            <a href="/salas" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-person-booth"></i>
              <p class="mb-0 d-none contenido">
                Salas
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center">
            <a href="/clientes" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-users"></i>
              <p class="mb-0 d-none contenido">
                Clientes
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center">
            <a href="/ventas" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-money-bill"></i>
              <p class="mb-0 d-none contenido">
                Ventas
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center">
            <a href="/productos" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-brands fa-apple"></i>
              <p class="mb-0 d-none contenido">
                Productos
              </p>
            </a>
          </li>
        </ul>
      </div>
    </header>

    <!-- navegacion -->
    <header class="w-100 z-1 position-fixed  border-bottom d-md-none bg-body">
      <div class="p-2 d-flex justify-content-between">
        <button type="button" class="btn btn-primary" onclick="togleMenu()">
          <i class="fa-solid fa-bars"></i>
        </button>
      </div>
      <div class="bg-body border-end border-top d-none p-2" id="menuRes">
        <div class="d-flex justify-content-center">
          <div class="d-flex align-items-center p-4 gap-2 d-none contenido">
            <div class="d-flex bg-black p-2 rounded-1">
              <p class="card-title p-1 pe-0 text-light fw-bold">
                Cinema
              </p>
              <p class="card-title p-1 rounded-1 fw-bold" style="background-color: #F69416;">
                Hub
              </p>
            </div>
          </div>
        </div>
        <ul class="d-flex flex-column list-unstyled ps-2 pe-2">
          <li class="d-flex align-items-center justify-content-center">
            <a href="/peliculas" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-film"></i>
              <p class="mb-0 d-none contenido">
                Peliculas
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center bg-dark">
            <a href="/funciones" class="text-white w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-masks-theater"></i>
              <p class="mb-0 d-none contenido">
                Funciones
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center">
            <a href="/salas" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-person-booth"></i>
              <p class="mb-0 d-none contenido">
                Salas
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center">
            <a href="/clientes" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-users"></i>
              <p class="mb-0 d-none contenido">
                Clientes
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center">
            <a href="/ventas" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-solid fa-money-bill"></i>
              <p class="mb-0 d-none contenido">
                Ventas
              </p>
            </a>
          </li>
          <li class="d-flex align-items-center justify-content-center">
            <a href="/productos" class="text-body w-100 p-2 d-flex gap-2 align-items-center list-group-item fs-5">
              <i class="fa-brands fa-apple"></i>
              <p class="mb-0 d-none contenido">
                Productos
              </p>
            </a>
          </li>
        </ul>
      </div>
    </header>



    <% if (status===200) { %>
      <div class="position-fixed w-100 z-1 d-flex justify-content-center p-4 divContain" id="divContain">
        <div class="alert alert-success  w-80 w-sm-50 w-md-25 d-flex justify-content-between alerta" id="alerta">
          <div class="fw-bold">
            <%= mensaje %>
          </div>
          <button type="button" class="btn-close" onclick="cerrarAlerta()"></button>
        </div>
      </div>
      <% } else { %>
        <div class="position-fixed w-100 z-1 d-flex justify-content-center p-4" id="divContain">
          <div class="alert alert-danger  w-80 w-sm-50 w-md-25 d-flex justify-content-between alerta" id="alerta">
            <div class="fw-bold">
              <%= mensaje %>
            </div>
            <button type="button" class="btn-close" onclick="cerrarAlerta()"></button>
          </div>
        </div>
        <% } %>


          <div class="w-100">
            <br>
            <section class="py-5 text-center container">
              <div class="row py-lg-5">
                <div class="col-lg-6 col-md-8 mx-auto">
                  <h1 class="fw-light">Gestión de salas</h1>
                  <p class="lead text-body-secondary">
                    Bienvenido al panel de administración de Funciones. Aquí puedes agregar, editar y eliminar
                  </p>
                  <div class="d-flex flex-wrap gap-2 align-items-center justify-content-center">
                    <button type="button" class="btn btn-primary my-2" data-bs-toggle="modal"
                      data-bs-target="#agregarModal">
                      <i class="fa-solid fa-plus"></i> Agregar
                    </button>
                    <form action="/funciones/busqueda" method="post" id="formBuscar"
                      class="d-flex align-items-center gap-2">
                      <div class="d-flex flex-column align-items-start">
                        <input type="text" class="form-control" name="titulo_bu" id="titulo_bu"
                          placeholder="Titulo de película" />
                      </div>
                      <button class="btn btn-secondary my-2"><i class="fa-solid fa-magnifying-glass"></i>
                        Buscar</button>
                    </form>
                    <div class="w-100">
                      <form action="/funciones" method="get">
                        <button class="btn btn-outline-primary w-50 my-2">
                          <i class="fa-solid fa-rotate-right"></i>
                          Mostar todas
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </section>
            <div class="py-3">
              <div class="w-xl-70 w-lg-80 w-100 mx-auto">
                <div class="d-flex flex-column">
                  <% if(data.length> 0) {%>

                    <% data.forEach(function(funcion) { function convertirHora(hora24) { const [horas, minutos,
                      segundos]=hora24.split(':').map(Number); const fecha=new Date(); fecha.setHours(horas, minutos,
                      segundos); return fecha.toLocaleTimeString('es-ES', { hour: 'numeric' , minute: 'numeric' ,
                      hour12: true }); } %>
                      <div class="p-2">
                        <div class="card w-100">
                          <div class="card-body d-flex flex-column flex-md-row gap-4">

                            <div class="w-100 w-md-50 w-lg-35 w-xl-25">
                              <img src="/uploads/<%= funcion.cartelera %>" alt="<%= funcion.titulo %>" class="rounded-4"
                                width="100%">
                            </div>

                            <div class="w-100 w-lg-65">
                              <h1 class="card-title fs-5 fs-sm-1 fw-bold">
                                <i class="fa-solid fa-film"></i>
                                <strong>
                                  <%= funcion.titulo %>
                                </strong>
                              </h1>
                              <div class="card-text d-flex gap-2 ">
                                <i class="fa-solid fa-circle-info"></i>
                                <p class="">
                                  <%= funcion.sinopsis %>
                                </p>
                              </div>
                              <div class="card-text d-flex gap-2">
                                <i class="fa-solid fa-calendar"></i>
                                <p>
                                  <%= funcion.duracion %> <span class="text-muted">Min.</span>
                                </p>
                              </div>
                              <div class="d-flex gap-2 mb-2 align-items-center">
                                <i class="fa-solid fa-icons"></i>
                                <div class="card-text pt-1 pb-1 ps-2 pe-2 rounded-5 bg-warning">
                                  <%= funcion.genero %>
                                </div>
                              </div>

                              <div class="card-text d-flex gap-2">
                                <i class="fa-solid fa-list"></i>
                                <p>
                                  <strong>Clasificación:</strong>
                                  <%= funcion.clasificacion %>
                                </p>
                              </div>

                              <div class="d-flex flex-column flex-md-row gap-2 p-2 w-100">
                                <div class="card- d-flex gap-2 w-100 w-md-35">
                                  <div class="card p-2 w-100">
                                    <div class="card-title d-flex align-items-center justify-content-between">
                                      <h5 class="fw-bold mb-0">
                                        <%= convertirHora(funcion.hora)%>
                                      </h5>
                                      <div class="bg-primary ps-2 pe-2 pb-1 pt-1 rounded-4 text-light">
                                        <h5 class="mb-0">
                                          <%= funcion.tipo_sala %>
                                        </h5>
                                      </div>
                                    </div>
                                    <div class="card-text fs-6 text-muted d-flex gap-1">
                                      <i class="fa-solid fa-location-dot"></i>
                                      <p>
                                        Sala <%= funcion.sala %>
                                      </p>
                                    </div>

                                    <div class="card-text fs-6 text-muted d-flex gap-1">
                                      <i class="fa-solid fa-users"></i>
                                      <p>
                                        Asientos <%= funcion.asientos_dis %>/<%= funcion.asientos_existentes %>
                                      </p>
                                    </div>

                                    <div class="card-text fs-6 text-muted d-flex gap-1">
                                      <i class="fa-solid fa-money-bill"></i>
                                      <p>
                                        <%= (funcion.precio).toFixed(2) %>
                                      </p>
                                    </div>

                                  </div>
                                </div>
                                <div class="card-text d-flex gap-2">
                                  <div class="card p-2 w-100">
                                    <div class="d-flex flex-column gap-4">
                                      <button type="button" class="btn btn-outline-info" data-bs-toggle="modal"
                                        onclick="editar('<%= JSON.stringify(funcion) %>')"
                                        data-bs-target="#agregarModal">
                                        <i class="fa-solid fa-pen-to-square"></i> Editar
                                      </button>
                                      <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                                        onclick="eliminar('<%= funcion.id_funcion %>')" data-bs-target="#eliminarModal">
                                        <i class="fa-solid fa-trash"></i> Desactivar función
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>


                            </div>
                          </div>
                        </div>
                      </div>

                      <% });%>


                        <% } else {%>
                          <div class="alert alert-warning w-100 fs-4 fw-bold" role="alert">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            No hay funciones programadas.
                          </div>
                          <% }%>
                </div>

              </div>
            </div>
          </div>
  </main>

  <div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="eliminarModalLabel"><i class="fa-solid fa-film"></i> Eliminar película</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="card">
            <div class="card-body">
              <form action="/salas/eliminar" id="formEliminar" method="post">
                <p class="card-title text-center fs-4 p-2">
                  ¿Desea eliminar esta sala?
                </p>
                <div class="mb-3">
                  <button type="submit" class="btn btn-danger mb-3 w-100">
                    <i class="fa-solid fa-trash"></i> Eliminar
                  </button>
                  <button type="button" class="btn btn-outline-secondary w-100" data-bs-dismiss="modal">
                    <i class="fa-solid fa-ban"></i>
                    Cancelar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="agregarModal" tabindex="-1" aria-labelledby="agregarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="agregarModalLabel"><i class="fa-solid fa-film"></i> Agregar película</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Agregar sala</h5>
              <form action="/funciones/crear" method="post" id="formAgregar">
                <div class="form-floating mb-3">
                  <select class="form-select" name="id_pelicula" id="id_pelicula">
                    <option value="" selected disabled></option>
                    <% peliculas.forEach(function(peli) { %>
                      <option value="<%= peli.id_pelicula %>">
                        <%= peli.titulo %>
                      </option>
                      <% }) %>
                  </select>
                  <label for="peliculas">Películas</label>
                </div>
                <div class="form-floating mb-3">
                  <select class="form-select" name="id_sala" id="id_sala">
                    <option value="" selected disabled></option>
                    <% salas.forEach(function(sala) { %>
                      <option value="<%= sala.id_sala %>">
                        #<%= sala.numero_sala %> - Asientos disp. <%= sala.asientos %> - <%= sala.tipo_sala %>
                      </option>
                      <% }) %>
                  </select>
                  <label for="sala">Sala</label>
                </div>
                <div class="mb-3">
                  <label for="precio" class="form-label">Precio</label>
                  <input type="number" class="form-control" name="precio" id="precio" placeholder="Precio de la entrada"
                    min="0.00" step="0.01" maxlength="99999999" />
                </div>
                <div class="mb-3">
                  <label for="hora" class="form-label">Hora</label>
                  <input type="time" class="form-control" name="hora" id="hora" placeholder="Hora" />
                </div>
                <div class="mb-3">
                  <button type="submit" id="btnSubmit" class="btn btn-primary mb-3 w-100">
                    <i class="fa-solid fa-floppy-disk"></i> Guardar
                  </button>
                  <button type="button" class="btn btn-outline-secondary w-100" data-bs-dismiss="modal"
                    onclick="limpiar()">
                    <i class="fa-solid fa-ban"></i>
                    Cancelar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const elemento = document.getElementById("menuNav");
      // Cuando el mouse entra en el elemento
      elemento.addEventListener("mouseenter", () => {
        const navegacion = document.querySelectorAll('.contenido');
        elemento.classList.add('activo')
        elemento.classList.remove('inActivo')
        setTimeout(() => {
          navegacion.forEach(item => {
            item.classList.remove('d-none')
          })
        }, 100)

      });
      elemento.addEventListener("mouseleave", () => {
        const navegacion = document.querySelectorAll('.contenido');
        elemento.classList.remove('activo')
        elemento.classList.add('inActivo')
        setTimeout(() => {
          navegacion.forEach(item => {
            item.classList.add('d-none')
          })
        }, 100)
      })
    });

    let menuAct = false

    function togleMenu() {
      const menu = document.getElementById('menuRes')
      if (!menuAct) {
        menu.classList.remove('menuResIn')
        menu.classList.add('menuResAct')
        menu.classList.remove('d-none')
        const navegacion = document.querySelectorAll('.contenido');
        setTimeout(() => {
          navegacion.forEach(item => {
            item.classList.remove('d-none')
          })
        }, 100)
        menuAct = true
      } else {
        menu.classList.remove('menuResAct')
        menu.classList.add('menuResIn')
        setTimeout(() => {
          menu.classList.add('d-none')
        }, 200)
        const navegacion = document.querySelectorAll('.contenido');
        setTimeout(() => {
          navegacion.forEach(item => {
            item.classList.add('d-none')
          })
        }, 100)
        menuAct = false
      }
    }

    function editar(funcion) {
      funcion = funcion.replace(/[\u0000-\u001F\u007F-\u009F]/g, "");
      funcion = JSON.parse(funcion);
      document.getElementById('formAgregar').action = '/funciones/modificar/' + funcion.id_funcion + '?_method=PUT';
      document.getElementById('id_pelicula').value = funcion.id_pelicula;
      document.getElementById('id_sala').value = funcion.id_sala;
      document.getElementById('precio').value = funcion.precio;
      document.getElementById('hora').value = funcion.hora;

      const btnSubmit = document.getElementById('btnSubmit');
      btnSubmit.innerHTML = '<i class="fas fa-edit me-2"></i>Actualizar';
    }

    const eliminar = (id) => {
      document.getElementById('formEliminar').action = `/funciones/eliminar/${id}?_method=DELETE`;
    }

    const limpiar = () => {
      document.getElementById('formAgregar').action = '/funciones/crear';
      document.getElementById('id_pelicula').value = '';
      document.getElementById('id_sala').value = '';
      document.getElementById('precio').value = '';
      document.getElementById('hora').value = '';
      const btnSubmit = document.getElementById('btnSubmit');
      btnSubmit.innerHTML = '<i class="fas fa-save me-2"></i>Guardar';
    }

    const cerrarAlerta = () => {
      const alert = document.getElementById('alerta');
      alert.classList.remove('alerta');
      alert.classList.add('alertaSa');
      setTimeout(() => {
        document.getElementById('divContain').classList.add('d-none')
      }, 500);

    }
  </script>

</body>

</html>